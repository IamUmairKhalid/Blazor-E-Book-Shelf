@page "/Admin/Testimonials"
@using Microsoft.EntityFrameworkCore
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Testimonials</PageTitle>

<!-- Table -->

<div class="row  justify-content-center ">

    <div class="col-md-10 justify-content-center">
        <h2>
            Reviews Count (@Count)
        </h2>
        <table border="1" class="table mt-3 table-hover ">
            <thead class="custom-header">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Message</th>
                    <th scope="col">Rating</th>
                    <th scope="col">Img Url</th>
                    <th scope="col">Review Date</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Test)
                {
                    <tr style ="cursor:pointer" @onclick ="() => OnUpdateClick(item.Id)">
                        <td>@item.Id</td>
                        <td>@item.User.UserName</td>
                        <td>
                            <span class="short-text">@(item.Content.Length > 20 ? item.Content.Substring(0, 20) + "..." : item.Content)</span>
                        </td>
                        <td>
                            <div class="text-yellow-500" style="color: gold;">
                                @for (int i = 0; i < (int)item.Rating; i++)
                                {
                                    <i class="fas fa-star"></i>
                                }

                                @if (item.Rating - (int)item.Rating >= 0.25 && item.Rating - (int)item.Rating < 0.75)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }

                                @for (int i = 0; i < (5 - (int)item.Rating - ((item.Rating - (int)item.Rating >= 0.25 && item.Rating - (int)item.Rating < 0.75) ? 1 : 0)); i++)
                                {
                                    <i class="far fa-star"></i>
                                }
                            </div>
                        </td>
                        <td><span class="short-text">@(item.User.ProfilePictureUrl.Length > 15 ? item.User.ProfilePictureUrl.Substring(0, 15) + "..." : item.User.ProfilePictureUrl)</span></td>
                        <td>@item.CreatedAt</td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
</div>



<!-- Edit Details Start-->

<Modal @ref="updatemodal" Title="Review Detail" UseStaticBackdrop="true" CloseOnEscape="false" Size="ModalSize.Large">
    <BodyTemplate>
        <div class="d-flex justify-content-center mt-3">
            <div class="text-center">
                <img src="ProfileImages/@details.User.ProfilePictureUrl" class="rounded-circle shadow mb-3" alt="@details.User.UserName" width="150" height="150">
            </div>
        </div>
        <EditForm Model="@details" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="container mb-4 p-3">
                <div class="row g-4 ">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label>UserName</label>
                            <InputText class="form-control" readonly @bind-value="details.User.UserName" />
                        </div>

                        <div class="col-md-4">
                            <label>Email</label>
                            <InputText class="form-control" readonly @bind-value="details.User.Email" />
                        </div>

                        <div class="col-md-4">
                            <label>Reviewed At</label>
                            <InputDate class="form-control" readonly @bind-value="details.CreatedAt" />
                        </div>
                        

                        <div class="col-md-12">
                            <label class="form-label">Message</label>
                            <InputTextArea class="form-control" readonly @bind-Value="details.Content" />
                        </div>


                        <div class="col-md-6">
                            <div class="col-md-6">
                                <label class="form-label">Review Approval</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveSwitch" @bind="details.IsApproved">
                                <label class="form-check-label" for="isActiveSwitch">
                                    @(
                                      details.IsApproved == true ? "Approved" :
                                      details.IsApproved == false ? "Not Approved" :
                                      "Unknown"
                                      )
                                </label>
                            </div>
                        </div>


                        <div class="col-md-6">
                            <div class="col-md-6">
                                <label class="form-label">Rating</label>
                            </div>
                            <div class="text-yellow-500" style="color: gold;">
                                @for (int i = 0; i < (int)details.Rating; i++)
                                {
                                    <i class="fas fa-star"></i>
                                }

                                @if (details.Rating - (int)details.Rating >= 0.25 && details.Rating - (int)details.Rating < 0.75)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }

                                @for (int i = 0; i < (5 - (int)details.Rating - ((details.Rating - (int)details.Rating >= 0.25 && details.Rating - (int)details.Rating < 0.75) ? 1 : 0)); i++)
                                {
                                    <i class="far fa-star"></i>
                                }
                            </div>
                        </div>

                        <hr class="mt-5"/>
                        <div class="col-12 mt-3 text-end">
                            <a @onclick="()=>OnHideUpdateClick(details.Id)" class="btn btn-secondary " style="width: 47px; height: 40px">
                                <i class="bi bi-x-lg fs-5"></i>
                            </a>
                            |
                            <Button type="ButtonType.Submit" class="btn btn-outline-success" style="width: 47px; height: 40px">
                                <i class="bi bi-floppy fs-5"></i>
                            </Button>
                        </div>
                    </div>
                </div>

            </div>

        </EditForm>

    </BodyTemplate>
</Modal>

<!-- Edit Details End -->

<!--Toaster Alert message-->
<Toasts class="p-3" Messages="messages" AutoHide="true" StackLength="3" Placement="ToastsPlacement.TopRight" />




@code {
    List<ToastMessage> messages = new List<ToastMessage>();
    protected IEnumerable<Testimonial> Test { get; set; }
    private int Count => Test?.Count() ?? 0;
    private Testimonial details;

    protected override void OnInitialized()
    {

        Test = Db.Testimonials.Include(c => c.User).ToList();

    }


    <!-- Update Record Start-->
    private Modal updatemodal = default!;

    private async Task OnUpdateClick(int id)
    {
        details = Db.Testimonials.Include(c => c.User).FirstOrDefault(c => c.Id == id);
        await updatemodal.ShowAsync();
    }

    private async Task OnHideUpdateClick(int id)
    {
        await updatemodal.HideAsync();
    }

    private async Task HandleValidSubmit()
    {
        Db.Testimonials.Update(details);
        await Db.SaveChangesAsync();
        Test = Db.Testimonials.ToList();
        await updatemodal.HideAsync();
        messages.Add(CreateUpdateMessage(ToastType.Success));
    }
    <!-- Update Record Start-->

    <!-- Update Message Start-->
    private ToastMessage CreateUpdateMessage(ToastType toastType)
       => new ToastMessage
           {
               Type = toastType,
               Title = "Message",
               HelpText = $"{DateTime.Now}",
               Message = $"Hello,The Record is Successfully Saved. DateTime: {DateTime.Now}",
           };
    <!-- Update Message End-->
}